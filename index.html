<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Grundrissplaner Pro – Einklappbares Menü</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root { --px-per-cm: 37.8; --accent: #66bb6a; --panel-width: 300px; }
    html, body { margin: 0; padding: 0; background-color: #eceff1; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #000; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    #topBar { background: #37474f; color: white; padding: 8px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
    .toolbar { display: flex; gap: 8px; background: #fff; padding: 4px; border-radius: 6px; }
    .toolbar button { background: var(--accent); border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-weight: bold; font-size: 13px; color: #000; }
    
    #mainContainer { display: flex; flex: 1; overflow: hidden; position: relative; }

    /* SEITENMENÜ STYLES */
    #sidePanel { 
      width: var(--panel-width); 
      background: #fff; 
      border-right: 1px solid #cfd8dc; 
      padding: 12px; 
      overflow-y: auto; 
      font-size: 13px; 
      transition: transform 0.3s ease; 
      position: relative;
      z-index: 500;
    }
    #sidePanel.closed {
      transform: translateX(-100%);
      margin-right: calc(var(--panel-width) * -1); /* Platzhalter entfernen */
    }

    /* TOGGLE BUTTON */
    #menuToggle {
      position: absolute;
      left: var(--panel-width);
      top: 15px;
      background: #37474f;
      color: white;
      border: none;
      width: 25px;
      height: 40px;
      cursor: pointer;
      border-radius: 0 4px 4px 0;
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: left 0.3s ease;
      font-weight: bold;
    }
    #sidePanel.closed + #menuToggle {
      left: 0;
    }

    #sidePanel h3 { margin: 0 0 10px 0; border-bottom: 2px solid var(--accent); font-size: 16px; }

    #printAreaWrapper { flex: 1; overflow: auto; padding: 20px; display: flex; justify-content: center; background-color: #cfd8dc; }
    #printArea { width: 1587px; height: 1085px; background-color: #fff; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); flex-shrink: 0; }
    
    #planHeader { display: flex; justify-content: space-between; padding: 10px 20px; background-color: #f1f8e9; border-bottom: 1px solid #a5d6a7; align-items: center; }
    #floorplan { width: 100%; height: calc(100% - 75px); position: relative; background-image: radial-gradient(#d1d1d1 0.5px, transparent 0.5px); background-size: 25px 25px; }

    .element { position: absolute; cursor: move; box-sizing: border-box; touch-action: none; }
    .room { background-color: rgba(0,123,255,0.03); }
    .wall { position: absolute; background-color: #78909c; pointer-events: none; }
    .wall.außen { background-color: #263238; }
    .door { background-color: #7B3F00; border: 1px solid #3e2723; }
    .window { background-color: #bbdefb; border: 2px solid #0D47A1; }
    .furniture { background-color: #cfd8dc; border: 1px solid #546e7a; }
    
    .selected { outline: 2px solid #f44336; outline-offset: 2px; }
    .handle { position: absolute; width: 12px; height: 12px; border-radius: 50%; z-index: 10; }
    .resize-handle { background: #f44336; right: -6px; bottom: -6px; cursor: se-resize; }
    .rotate-handle { background: #4caf50; top: -30px; left: 50%; transform: translateX(-50%); cursor: alias; }

    .element-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold; pointer-events: none; text-align: center; white-space: pre; }
    .wall-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; background: white; padding: 1px 2px; border: 0.5px solid #000; }

    .dim-chain { position: absolute; pointer-events: none; }
    .dim-line { position: absolute; background-color: #000; }
    .dim-tick { position: absolute; background-color: #000; width: 1px !important; height: 10px !important; }
    .dim-ext-label { position: absolute; font-size: 11px; font-weight: bold; background: white; padding: 0 3px; transform: translate(-50%, -50%); }

    input, select { width: 100%; padding: 5px; margin: 2px 0 8px 0; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; box-sizing: border-box; }
    .group { margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee; }
    .wall-row { display: flex; gap: 5px; align-items: center; margin-bottom: 3px; }
    .wall-row label { width: 30px; font-weight: bold; }

    @media print {
      body { background: white; }
      #topBar, #sidePanel, #menuToggle, .handle { display: none !important; }
      #printAreaWrapper { padding: 0; }
      #printArea { box-shadow: none; border: none; }
    }
  </style>
</head>
<body>

<div id="topBar">
  <div style="font-weight: bold;">Grundrissplaner 1:50</div>
  <div class="toolbar">
    <button onclick="addRoom()">+ Raum</button>
    <button onclick="addDoor()">+ Tür</button>
    <button onclick="addWindow()">+ Fenster</button>
    <button onclick="addFurniture()">+ Möbel</button>
    <button onclick="addNorthArrow()" style="background:#ffca28;">Nordpfeil</button>
    <button onclick="printLayout()" style="background:#42a5f5; color:white;">PDF Export</button>
  </div>
</div>

<div id="mainContainer">
  <div id="sidePanel">
    <h3>Projekt-Info</h3>
    Projekt: <input type="text" id="projectName" value="Neubau" oninput="updateGlobalSettings()">
    Adresse: <input type="text" id="address" value="Musterweg 5" oninput="updateGlobalSettings()">
    Raumhöhe (cm): <input type="number" id="roomHeight" value="250" oninput="updateGlobalSettings()">

    <div id="props" style="display:none;">
      <h3>Eigenschaften</h3>
      Breite (cm): <input type="number" id="propWidth" oninput="updateProperties()">
      Höhe/Tiefe (cm): <input type="number" id="propHeight" oninput="updateProperties()">
      Rotation (°): <input type="number" id="propRotation" oninput="updateProperties()">
      
      <div id="roomExtra" style="display:none;">
        <strong>Wände (Stärke & Typ)</strong>
        <div class="group">
          <div class="wall-row"><label>Ob:</label><input type="number" id="propWallTop" oninput="updateProperties()"><select id="propWallTypeTop" oninput="updateProperties()"><option value="innen">innen</option><option value="außen">außen</option></select></div>
          <div class="wall-row"><label>Re:</label><input type="number" id="propWallRight" oninput="updateProperties()"><select id="propWallTypeRight" oninput="updateProperties()"><option value="innen">innen</option><option value="außen">außen</option></select></div>
          <div class="wall-row"><label>Un:</label><input type="number" id="propWallBottom" oninput="updateProperties()"><select id="propWallTypeBottom" oninput="updateProperties()"><option value="innen">innen</option><option value="außen">außen</option></select></div>
          <div class="wall-row"><label>Li:</label><input type="number" id="propWallLeft" oninput="updateProperties()"><select id="propWallTypeLeft" oninput="updateProperties()"><option value="innen">innen</option><option value="außen">außen</option></select></div>
        </div>
        Bezeichnung: <input type="text" id="propRoomLabel" oninput="updateProperties()">
      </div>
      <button onclick="deleteSelectedElement()" style="background:#ef5350; color:white; width:100%; border:none; padding:8px; border-radius:4px; cursor:pointer; font-weight:bold;">Löschen</button>
    </div>
  </div>

  <button id="menuToggle" onclick="toggleMenu()">◀</button>

  <div id="printAreaWrapper">
    <div id="printArea">
      <div id="planHeader">
        <div>
          <strong id="planProjectName">Projekt: Neubau</strong><br>
          <span id="planAddress" style="font-size:12px;">Musterweg 5</span>
        </div>
        <div style="text-align: center; font-weight: bold; font-size: 16px; color: #1b5e20;">
          mein-online-energieausweis.at
        </div>
        <div style="text-align: right; font-size: 11px;">
          Datum: <span id="planDate"></span><br>
          Raumhöhe: <span id="planRoomHeight">250</span> cm
        </div>
      </div>
      <div id="floorplan"></div>
    </div>
  </div>
</div>

<script>
  const scaleFactor = 50; 
  const pxPerCm = 37.8;   
  let selectedElement = null;
  let elementCounter = 0;

  function cmToPx(val) { return (val / scaleFactor) * pxPerCm; }

  // NEUE FUNKTION FÜR DAS MENÜ
  function toggleMenu() {
    const panel = document.getElementById("sidePanel");
    const toggleBtn = document.getElementById("menuToggle");
    panel.classList.toggle("closed");
    
    if (panel.classList.contains("closed")) {
      toggleBtn.innerText = "▶";
    } else {
      toggleBtn.innerText = "◀";
    }
  }

  function updateGlobalSettings() {
    document.getElementById("planProjectName").innerText = "Projekt: " + document.getElementById("projectName").value;
    document.getElementById("planAddress").innerText = document.getElementById("address").value;
    document.getElementById("planRoomHeight").innerText = document.getElementById("roomHeight").value;
    document.getElementById("planDate").innerText = new Date().toLocaleDateString();
  }

  function updateElementLabel(el) {
    let label = el.querySelector(".element-label");
    if (!label) return;
    const w = el.dataset.realWidth;
    const h = el.dataset.realHeight;
    if (el.classList.contains("room")) {
      const area = ((w * h) / 10000).toFixed(2);
      label.innerText = (el.dataset.roomLabel || "Raum") + "\n" + w + "x" + h + "\n" + area + " m²";
    } else {
      let type = el.classList.contains("door") ? "TÜR" : el.classList.contains("window") ? "FENSTER" : "MÖBEL";
      label.innerText = type + "\n" + w + " x " + h;
    }
  }

  function updateRoomWalls(el) {
    const t = parseFloat(el.dataset.wallTop || 0), r = parseFloat(el.dataset.wallRight || 0);
    const b = parseFloat(el.dataset.wallBottom || 0), l = parseFloat(el.dataset.wallLeft || 0);
    const rw = parseFloat(el.dataset.realWidth), rh = parseFloat(el.dataset.realHeight);

    ['top', 'right', 'bottom', 'left'].forEach(pos => {
      let wallDiv = el.querySelector(".wall-" + pos);
      let thickness = parseFloat(el.dataset["wall" + pos.charAt(0).toUpperCase() + pos.slice(1)]);
      let type = el.dataset["wallType" + pos.charAt(0).toUpperCase() + pos.slice(1)];
      wallDiv.className = "wall wall-" + pos + (type === "außen" ? " außen" : "");

      if(pos === 'top') {
        wallDiv.style.top = -cmToPx(t) + "px"; wallDiv.style.left = -cmToPx(l) + "px";
        wallDiv.style.width = cmToPx(rw + l + r) + "px"; wallDiv.style.height = cmToPx(t) + "px";
      } else if(pos === 'bottom') {
        wallDiv.style.bottom = -cmToPx(b) + "px"; wallDiv.style.left = -cmToPx(l) + "px";
        wallDiv.style.width = cmToPx(rw + l + r) + "px"; wallDiv.style.height = cmToPx(b) + "px";
      } else if(pos === 'left') {
        wallDiv.style.left = -cmToPx(l) + "px"; wallDiv.style.top = "0px";
        wallDiv.style.width = cmToPx(l) + "px"; wallDiv.style.height = cmToPx(rh) + "px";
      } else if(pos === 'right') {
        wallDiv.style.right = -cmToPx(r) + "px"; wallDiv.style.top = "0px";
        wallDiv.style.width = cmToPx(r) + "px"; wallDiv.style.height = cmToPx(rh) + "px";
      }
      let wl = wallDiv.querySelector(".wall-label");
      if (thickness > 0) {
        if (!wl) { wl = document.createElement("span"); wl.className = "wall-label"; wallDiv.appendChild(wl); }
        wl.innerText = thickness;
      } else if (wl) wl.remove();
    });
    updateDimensionChain(el, rw, rh, t, r, b, l);
  }

  function updateDimensionChain(el, rw, rh, t, r, b, l) {
    let dimH = el.querySelector(".dim-chain-h"), dimV = el.querySelector(".dim-chain-v");
    if(!dimH) {
      dimH = document.createElement("div"); dimH.className = "dim-chain dim-chain-h";
      dimH.innerHTML = '<div class="dim-line"></div><div class="dim-tick t1"></div><div class="dim-tick t2"></div><div class="dim-ext-label"></div>';
      el.appendChild(dimH);
    }
    if(!dimV) {
      dimV = document.createElement("div"); dimV.className = "dim-chain dim-chain-v";
      dimV.innerHTML = '<div class="dim-line"></div><div class="dim-tick t1"></div><div class="dim-tick t2"></div><div class="dim-ext-label"></div>';
      el.appendChild(dimV);
    }
    const offset = 35, totalW = rw + l + r, totalH = rh + t + b;
    dimH.style.top = (-cmToPx(t) - offset) + "px"; dimH.style.left = -cmToPx(l) + "px"; dimH.style.width = cmToPx(totalW) + "px";
    dimH.querySelector(".dim-line").style.width = "100%"; dimH.querySelector(".dim-line").style.height = "1px"; 
    dimH.querySelector(".t1").style.left = "0"; dimH.querySelector(".t1").style.transform = "rotate(45deg)";
    dimH.querySelector(".t2").style.right = "0"; dimH.querySelector(".t2").style.transform = "rotate(45deg)";
    dimH.querySelector(".dim-ext-label").innerText = totalW; dimH.querySelector(".dim-ext-label").style.left = "50%"; dimH.querySelector(".dim-ext-label").style.top = "0";
    dimV.style.left = (-cmToPx(l) - offset) + "px"; dimV.style.top = -cmToPx(t) + "px"; dimV.style.height = cmToPx(totalH) + "px"; dimV.style.width = "1px";
    dimV.querySelector(".dim-line").style.height = "100%"; dimV.querySelector(".dim-line").style.width = "1px";
    dimV.querySelector(".t1").style.top = "0"; dimV.querySelector(".t1").style.left = "-5px"; dimV.querySelector(".t1").style.transform = "rotate(45deg)";
    dimV.querySelector(".t2").style.bottom = "0"; dimV.querySelector(".t2").style.left = "-5px"; dimV.querySelector(".t2").style.transform = "rotate(45deg)";
    dimV.querySelector(".dim-ext-label").innerText = totalH; dimV.querySelector(".dim-ext-label").style.top = "50%"; dimV.querySelector(".dim-ext-label").style.left = "0";
    dimV.querySelector(".dim-ext-label").style.transform = "translate(-50%, -50%) rotate(-90deg)";
  }

  function createElement(type, defaults) {
    elementCounter++;
    const el = document.createElement("div");
    el.classList.add("element", type);
    el.id = type + elementCounter;
    el.style.left = defaults.left + "px"; el.style.top = defaults.top + "px";
    let visH = (type === "door" || type === "window") ? 15 : defaults.height;
    el.style.width = cmToPx(defaults.width) + "px"; el.style.height = cmToPx(visH) + "px";
    el.dataset.realWidth = defaults.width; el.dataset.realHeight = defaults.height;

    const label = document.createElement("div"); label.className = "element-label"; el.appendChild(label);
    if (type === "room") {
      Object.assign(el.dataset, { wallTop: 10, wallRight: 10, wallBottom: 10, wallLeft: 10, wallTypeTop: "innen", wallTypeRight: "innen", wallTypeBottom: "innen", wallTypeLeft: "innen", roomLabel: "Raum " + elementCounter });
      ['top', 'right', 'bottom', 'left'].forEach(p => { let w = document.createElement("div"); w.className = "wall wall-" + p; el.appendChild(w); });
      updateRoomWalls(el);
    } else if (type === "northarrow") {
        el.innerHTML = `<svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="display:block;"><path d="M50 2 L15 45 H40 V98 H60 V45 H85 Z" fill="black" stroke="white" stroke-width="2"/><text x="50" y="32" fill="white" font-size="16" text-anchor="middle" font-weight="bold">N</text></svg>`;
    }
    updateElementLabel(el);
    const rH = document.createElement("div"); rH.className = "handle resize-handle"; el.appendChild(rH);
    const roH = document.createElement("div"); roH.className = "handle rotate-handle"; el.appendChild(roH);
    el.addEventListener("pointerdown", (e) => { if(!e.target.classList.contains("handle")) selectElement(el); });
    makeDraggable(el); makeResizable(el, rH); makeRotatable(el, roH);
    document.getElementById("floorplan").appendChild(el);
    selectElement(el);
  }

  function makeDraggable(el) {
    el.addEventListener('pointerdown', e => {
      if (e.target.classList.contains('handle')) return;
      let sx = e.clientX, sy = e.clientY, ox = el.offsetLeft, oy = el.offsetTop;
      const move = e => { el.style.left = (ox + e.clientX - sx) + 'px'; el.style.top = (oy + e.clientY - sy) + 'px'; };
      const stop = () => { document.removeEventListener('pointermove', move); document.removeEventListener('pointerup', stop); };
      document.addEventListener('pointermove', move); document.addEventListener('pointerup', stop);
    });
  }

  function makeResizable(el, handle) {
    handle.addEventListener('pointerdown', e => {
      e.stopPropagation();
      let sx = e.clientX, sy = e.clientY, sw = el.offsetWidth, sh = el.offsetHeight;
      const move = e => {
        let nw = sw + (e.clientX - sx), nh = sh + (e.clientY - sy);
        el.style.width = nw + "px"; 
        if (!el.classList.contains("door") && !el.classList.contains("window")) el.style.height = nh + "px";
        el.dataset.realWidth = Math.round((nw / pxPerCm) * scaleFactor);
        if (!el.classList.contains("door") && !el.classList.contains("window")) el.dataset.realHeight = Math.round((nh / pxPerCm) * scaleFactor);
        updateElementLabel(el); if(el.classList.contains("room")) updateRoomWalls(el);
        updatePropertiesPanel();
      };
      const stop = () => { document.removeEventListener('pointermove', move); document.removeEventListener('pointerup', stop); };
      document.addEventListener('pointermove', move); document.addEventListener('pointerup', stop);
    });
  }

  function makeRotatable(el, handle) {
    handle.addEventListener('pointerdown', e => {
      e.stopPropagation();
      let rect = el.getBoundingClientRect(), cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
      let startAngle = Math.atan2(e.clientY - cy, e.clientX - cx), initialRot = el._rot || 0;
      const move = e => {
        let ang = Math.atan2(e.clientY - cy, e.clientX - cx);
        el._rot = initialRot + (ang - startAngle) * (180/Math.PI);
        el.style.transform = `rotate(${el._rot}deg)`;
        updatePropertiesPanel();
      };
      const stop = () => { document.removeEventListener('pointermove', move); document.removeEventListener('pointerup', stop); };
      document.addEventListener('pointermove', move); document.addEventListener('pointerup', stop);
    });
  }

  function selectElement(el) {
    if(selectedElement) selectedElement.classList.remove("selected");
    selectedElement = el; selectedElement.classList.add("selected");
    document.getElementById("props").style.display = "block";
    updatePropertiesPanel();
  }

  function updatePropertiesPanel() {
    if(!selectedElement) return;
    document.getElementById("propWidth").value = selectedElement.dataset.realWidth;
    document.getElementById("propHeight").value = selectedElement.dataset.realHeight;
    document.getElementById("propRotation").value = Math.round(selectedElement._rot || 0);
    const isRoom = selectedElement.classList.contains("room");
    document.getElementById("roomExtra").style.display = isRoom ? "block" : "none";
    if(isRoom) {
      ['Top','Right','Bottom','Left'].forEach(p => {
          document.getElementById("propWall" + p).value = selectedElement.dataset["wall"+p];
          document.getElementById("propWallType" + p).value = selectedElement.dataset["wallType"+p];
      });
      document.getElementById("propRoomLabel").value = selectedElement.dataset.roomLabel;
    }
  }

  function updateProperties() {
    if(!selectedElement) return;
    const w = document.getElementById("propWidth").value, h = document.getElementById("propHeight").value;
    selectedElement.dataset.realWidth = w; selectedElement.dataset.realHeight = h;
    selectedElement.style.width = cmToPx(w) + "px";
    if (!selectedElement.classList.contains("door") && !selectedElement.classList.contains("window")) selectedElement.style.height = cmToPx(h) + "px";
    selectedElement._rot = document.getElementById("propRotation").value;
    selectedElement.style.transform = `rotate(${selectedElement._rot}deg)`;
    updateElementLabel(selectedElement);
    if(selectedElement.classList.contains("room")) {
      ['Top','Right','Bottom','Left'].forEach(p => {
          selectedElement.dataset["wall"+p] = document.getElementById("propWall" + p).value;
          selectedElement.dataset["wallType"+p] = document.getElementById("propWallType" + p).value;
      });
      selectedElement.dataset.roomLabel = document.getElementById("propRoomLabel").value;
      updateRoomWalls(selectedElement);
    }
  }

  function deleteSelectedElement() { if(selectedElement) { selectedElement.remove(); selectedElement = null; document.getElementById("props").style.display = "none"; } }
  function addRoom() { createElement("room", { left: 100, top: 100, width: 400, height: 300 }); }
  function addDoor() { createElement("door", { left: 150, top: 150, width: 80, height: 210 }); }
  function addWindow() { createElement("window", { left: 200, top: 200, width: 120, height: 140 }); }
  function addFurniture() { createElement("furniture", { left: 250, top: 250, width: 100, height: 60 }); }
  function addNorthArrow() { createElement("northarrow", { left: 50, top: 50, width: 60, height: 60 }); }

  function printLayout() {
    updateGlobalSettings();
    const element = document.getElementById("printArea");
    html2pdf().set({ margin: 0, filename: 'Plan.pdf', jsPDF: { unit: 'px', format: [1587, 1085], orientation: 'landscape' } }).from(element).save();
  }
  
  updateGlobalSettings();
</script>
</body>
</html>
