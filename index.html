<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Grundrissplaner – PDF-Ausgabe, 1:50, kompakt, alle Texte schwarz</title>
  <!-- html2pdf.js von CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --px-per-cm: 37.8; /* 1 cm Papier ≈ 37,8 px (bei 96 dpi) */
    }
    /* Fester Maßstab 1:50 – alle Eingaben in cm werden über cmToPx() umgerechnet */

    html, body {
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #000; /* Alle Texte schwarz */
    }
    h1, h2, h3, h4, p {
      margin: 0;
      padding: 0;
    }

    /* Eingabe-Bereich (nicht gedruckt) */
    #headerContainer {
      width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #headerContainer h2 {
      margin-bottom: 10px;
      color: #000;
    }
    #headerContainer input {
      width: 100%;
      max-width: 380px;
      margin: 5px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      color: #000;
    }

    /* Toolbar */
    .toolbar {
      text-align: center;
      margin: 15px auto;
    }
    .toolbar button {
      background-color: #66bb6a;
      color: #000;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      transition: background 0.3s;
    }
    .toolbar button:hover {
      background-color: #57a05a;
    }
    .toolbar button.northarrow {
      background-color: #ffcc00;
    }

    /*
      A3 Querformat bei 96 dpi: ca. 1587 x 1123 px.
      Wir ziehen 38 px ab (1 cm) unten: 1587 x 1085 px.
    */
    #printArea {
      width: 1587px;
      height: 1085px;
      margin: 0 auto;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
    }

    /* Kopfbereich (PlanHeader) – kompakt */
    #planHeader {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background-color: #c8e6c9;
      color: #000;
      border-bottom: 1px solid #a5d6a7;
      padding: 5px 10px;
    }
    #planInfo {
      display: flex;
      flex-direction: column;
      font-size: 14px;
      line-height: 1.2;
      margin: 0;
      padding: 0;
    }
    #planInfo p {
      margin: 2px 0;
    }
    /* Kein Maßstabstext */
    #planExtra {
      text-align: right;
      font-size: 14px;
      line-height: 1.2;
    }
    /* Legende – exakte Wandfarben: Innenwand (#888), Außenwand (#444) */
    #legend {
      font-size: 14px;
      color: #000;
      margin-bottom: 2px;
    }
    #legend .legend-box {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 5px;
      vertical-align: middle;
      border: 1px solid #000;
    }
    #legend .legend-box.innen {
      background-color: #888;
    }
    #legend .legend-box.außen {
      background-color: #444;
    }
    #extraText {
      font-size: 14px;
      font-weight: bold;
    }

    /* Zeichenfläche (Floorplan) – restliche Höhe */
    #floorplan {
      width: 100%;
      height: calc(100% - 40px); /* ca. 40px für den Kopf */
      position: relative;
      background-image:
        linear-gradient(0deg, transparent 24%, rgba(0,0,0,0.1) 25%, rgba(0,0,0,0.1) 26%, transparent 27%, transparent 74%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1) 76%, transparent 77%, transparent),
        linear-gradient(90deg, transparent 24%, rgba(0,0,0,0.1) 25%, rgba(0,0,0,0.1) 26%, transparent 27%, transparent 74%, rgba(0,0,0,0.1) 75%, rgba(0,0,0,0.1) 76%, transparent 77%, transparent);
      background-size: 50px 50px;
      transform: scale(1);
      transform-origin: top left;
      overflow: hidden;
    }

    /* Elemente (Räume, Türen, Fenster, Möbel, Nordpfeil) */
    .element {
      position: absolute;
      cursor: move;
      box-sizing: border-box;
      touch-action: none;
    }
    .room {
      background-color: rgba(0,123,255,0.05);
    }
    .wall {
      position: absolute;
      background-color: #888;
      pointer-events: none;
    }
    .wall.außen {
      background-color: #444;
    }
    .door {
      background-color: #7B3F00;
      border: 1px solid #5A2E00;
    }
    .window {
      background-color: #0D47A1;
      border: 1px solid #0B3D91;
    }
    .furniture {
      background-color: #666;
      border: 1px solid #444;
    }
    /* Nordpfeil – eigener Elementtyp */
    .northarrow {
      /* Größe wird über cmToPx() gesetzt */
    }
    .selected {
      outline: 2px dashed red;
    }
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: red;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      touch-action: none;
    }
    .rotate-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: green;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      cursor: pointer;
      touch-action: none;
    }
    .element-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 14px;
      font-weight: bold;
      pointer-events: none;
      color: #000;
    }
    .dim-label {
      position: absolute;
      bottom: 0;
      left: 0;
      font-size: 12px;
      background: rgba(255,255,255,0.9);
      padding: 2px 4px;
      border-top-right-radius: 4px;
      color: #000;
    }
    /* Neue CSS-Regel für die Wandstärken-Beschriftung */
    .wall-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: normal;
      background: rgba(255,255,255,0.7);
      padding: 2px 4px;
      border-radius: 3px;
      color: #000;
      pointer-events: none;
    }

    /* Eigenschaften-Panel (nicht gedruckt) */
    #propertiesPanel {
      width: 800px;
      margin: 20px auto;
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      color: #000;
    }
    #propertiesPanel h3 {
      margin-bottom: 15px;
      font-size: 20px;
      color: #000;
    }
    #propertiesPanel div {
      margin-bottom: 12px;
    }
    #propertiesPanel label {
      display: inline-block;
      width: 120px;
      font-weight: bold;
      color: #000;
    }
    #propertiesPanel input,
    #propertiesPanel select {
      padding: 8px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 4px;
      color: #000;
    }

    /* Print Styles – Direkte PDF-Ausgabe */
    @media print {
      @page {
        size: A3 landscape;
        margin: 0;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      #printArea {
        margin: 0;
        position: static;
        transform: none !important;
      }
      .resize-handle, .rotate-handle, .selected {
        display: none !important;
      }
      #planHeader {
        background-color: #fff !important;
        color: #000 !important;
        border-bottom: 1px solid #ccc !important;
      }
      #legend .legend-box.innen {
        background-color: #888 !important;
      }
      #legend .legend-box.außen {
        background-color: #444 !important;
      }
    }
  </style>
</head>
<body>

<!-- Eingabe-Bereich (nicht gedruckt) -->
<div id="headerContainer">
  <h2>Projektinformationen</h2>
  <div>
    Projektname: <input type="text" id="projectName" value="Mein Projekt"><br>
    Adresse: <input type="text" id="address" value="Musterstraße 1, 12345 Musterstadt"><br>
    Planer: <input type="text" id="plannerName" value="Max Mustermann"><br>
    Raumhöhe (cm): <input type="number" id="roomHeight" value="250"><br>
    <button onclick="updateGlobalSettings()">Einstellungen übernehmen</button>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <button onclick="addRoom()">Raum hinzufügen</button>
  <button onclick="addDoor()">Tür hinzufügen</button>
  <button onclick="addWindow()">Fenster hinzufügen</button>
  <button onclick="addFurniture()">Möbel hinzufügen</button>
  <button onclick="addNorthArrow()" class="northarrow">Nordpfeil hinzufügen</button>
  <button onclick="printLayout()">Drucken (PDF)</button>
</div>

<!-- Druckbereich (1587 x 1085 px) -->
<div id="printArea">
  <div id="planHeader">
    <div id="planInfo">
      <h1 id="planProjectName" style="font-size:16px;margin:2px 0;">Projekt: Mein Projekt</h1>
      <p>Adresse: <span id="planAddress">Musterstraße 1, 12345 Musterstadt</span></p>
      <p>Planer: <span id="planPlannerName">Max Mustermann</span></p>
      <p>Raumhöhe: <span id="planRoomHeight">250</span> cm</p>
      <p>Datum: <span id="planDate"></span></p>
    </div>
    <div id="planExtra">
      <div id="legend">
        <div><span class="legend-box innen"></span>Innenwand</div>
        <div><span class="legend-box außen"></span>Außenwand</div>
      </div>
      <div id="extraText">Energieausweis Ing. Michael Neumann    ing-neumann.at</div>
    </div>
  </div>
  <div id="floorplan"></div>
</div>

<!-- Eigenschaften-Panel (nicht gedruckt) -->
<div id="propertiesPanel">
  <h3>Eigenschaften (Alle Maße in cm)</h3>
  <div>
    <label for="propWidth">Breite:</label>
    <input type="number" id="propWidth" placeholder="cm">
  </div>
  <div>
    <label for="propHeight">Höhe:</label>
    <input type="number" id="propHeight" placeholder="cm">
  </div>
  <div>
    <label for="propRotation">Rotation (°):</label>
    <input type="number" id="propRotation">
  </div>
  <!-- Zusätzliche Felder für Räume -->
  <div id="roomExtra" style="display:none;">
    <h4>Raum-Wände</h4>
    <div class="wall-prop">
      <label for="propWallTop">Oben (cm):</label>
      <input type="number" id="propWallTop" placeholder="cm">
      <select id="propWallTypeTop">
        <option value="innen">innen</option>
        <option value="außen">außen</option>
      </select>
    </div>
    <div class="wall-prop">
      <label for="propWallRight">Rechts (cm):</label>
      <input type="number" id="propWallRight" placeholder="cm">
      <select id="propWallTypeRight">
        <option value="innen">innen</option>
        <option value="außen">außen</option>
      </select>
    </div>
    <div class="wall-prop">
      <label for="propWallBottom">Unten (cm):</label>
      <input type="number" id="propWallBottom" placeholder="cm">
      <select id="propWallTypeBottom">
        <option value="innen">innen</option>
        <option value="außen">außen</option>
      </select>
    </div>
    <div class="wall-prop">
      <label for="propWallLeft">Links (cm):</label>
      <input type="number" id="propWallLeft" placeholder="cm">
      <select id="propWallTypeLeft">
        <option value="innen">innen</option>
        <option value="außen">außen</option>
      </select>
    </div>
    <div>
      <label for="propRoomLabel">Raumbezeichnung:</label>
      <input type="text" id="propRoomLabel">
    </div>
  </div>
  <!-- Für Türen, Fenster, Möbel -->
  <div id="elemExtra" style="display:none;">
    <div>
      <label for="propText">Text:</label>
      <input type="text" id="propText">
    </div>
  </div>
  <div>
    <button onclick="updateProperties()">Eigenschaften aktualisieren</button>
    <button onclick="deleteSelectedElement()">Element löschen</button>
  </div>
</div>

<script>
  const scaleFactor = 50; // Fester Maßstab 1:50
  const pxPerCm = 37.8;   // 1 cm Papier ≈ 37.8 px
  function cmToPx(val) {
    return (val / scaleFactor) * pxPerCm;
  }

  let selectedElement = null;
  let elementCounter = 0;

  function updateGlobalSettings() {
    document.getElementById("planProjectName").innerText = "Projekt: " + document.getElementById("projectName").value;
    document.getElementById("planAddress").innerText = document.getElementById("address").value;
    document.getElementById("planPlannerName").innerText = document.getElementById("plannerName").value;
    document.getElementById("planRoomHeight").innerText = document.getElementById("roomHeight").value;
    document.getElementById("planDate").innerText = new Date().toLocaleDateString();
    document.querySelectorAll('.room').forEach(updateRoomLabel);
  }

  function updateRoomLabel(el) {
    if (!el.classList.contains("room")) return;
    let label = el.querySelector(".element-label");
    if (!label) return;
    const realWidth = el.dataset.realWidth;
    const realHeight = el.dataset.realHeight;
    const area = ((realWidth * realHeight) / 10000).toFixed(2);
    label.innerText = (el.dataset.roomLabel || el.id) + " (" + realWidth + " x " + realHeight + " cm, " + area + " m²)";
  }

  function updateRoomWalls(el) {
    const walls = ['Top', 'Right', 'Bottom', 'Left'];
    walls.forEach(pos => {
      let wallDiv = el.querySelector(".wall-" + pos.toLowerCase());
      if (!wallDiv) return;
      let thickness = el.dataset["wall" + pos] ? parseFloat(el.dataset["wall" + pos]) : 0;
      let type = el.dataset["wallType" + pos] || "innen";
      if (type === "außen") {
        wallDiv.classList.add("außen");
      } else {
        wallDiv.classList.remove("außen");
      }
      if(pos === "Top"){
        wallDiv.style.top = -cmToPx(thickness) + "px";
        wallDiv.style.left = "0px";
        wallDiv.style.width = cmToPx(el.dataset.realWidth) + "px";
        wallDiv.style.height = cmToPx(thickness) + "px";
      } else if(pos === "Bottom"){
        wallDiv.style.bottom = -cmToPx(thickness) + "px";
        wallDiv.style.left = "0px";
        wallDiv.style.width = cmToPx(el.dataset.realWidth) + "px";
        wallDiv.style.height = cmToPx(thickness) + "px";
      } else if(pos === "Left"){
        wallDiv.style.left = -cmToPx(thickness) + "px";
        wallDiv.style.top = "0px";
        wallDiv.style.width = cmToPx(thickness) + "px";
        wallDiv.style.height = cmToPx(el.dataset.realHeight) + "px";
      } else if(pos === "Right"){
        wallDiv.style.right = -cmToPx(thickness) + "px";
        wallDiv.style.top = "0px";
        wallDiv.style.width = cmToPx(thickness) + "px";
        wallDiv.style.height = cmToPx(el.dataset.realHeight) + "px";
      }
      // Neue Funktionalität: Wandstärke-Beschriftung
      if (thickness > 0) {
        let wallLabel = wallDiv.querySelector(".wall-label");
        if (!wallLabel) {
          wallLabel = document.createElement("span");
          wallLabel.className = "wall-label";
          wallDiv.appendChild(wallLabel);
        }
        wallLabel.innerText = thickness + " cm";
      } else {
        let wallLabel = wallDiv.querySelector(".wall-label");
        if (wallLabel) {
          wallLabel.remove();
        }
      }
    });
  }

  function createElement(type, defaults) {
    elementCounter++;
    const el = document.createElement("div");
    el.classList.add("element", type);
    el.id = type + elementCounter;

    const drawWidth = cmToPx(defaults.width);
    const drawHeight = cmToPx(defaults.height);
    el.style.left = defaults.left + "px";
    el.style.top = defaults.top + "px";
    el.style.width = drawWidth + "px";
    el.style.height = drawHeight + "px";
    el.dataset.realWidth = defaults.width;
    el.dataset.realHeight = defaults.height;

    if (type === "room") {
      el.dataset.wallTop = defaults.wallTop || 10;
      el.dataset.wallRight = defaults.wallRight || 10;
      el.dataset.wallBottom = defaults.wallBottom || 10;
      el.dataset.wallLeft = defaults.wallLeft || 10;
      el.dataset.wallTypeTop = defaults.wallTypeTop || "innen";
      el.dataset.wallTypeRight = defaults.wallTypeRight || "innen";
      el.dataset.wallTypeBottom = defaults.wallTypeBottom || "innen";
      el.dataset.wallTypeLeft = defaults.wallTypeLeft || "innen";
      el.dataset.roomLabel = defaults.roomLabel || ("Raum " + elementCounter);

      const roomLabel = document.createElement("div");
      roomLabel.className = "element-label";
      roomLabel.innerText = el.dataset.roomLabel;
      el.appendChild(roomLabel);

      ["top", "right", "bottom", "left"].forEach(pos => {
        const wallDiv = document.createElement("div");
        wallDiv.className = "wall wall-" + pos;
        el.appendChild(wallDiv);
      });
    }
    else if (type === "door" || type === "window") {
      el.dataset.enteredHeight = defaults.height;
      el.style.height = cmToPx(20) + "px"; // fix: 20 cm sollen gezeichnet werden
      const elemLabel = document.createElement("div");
      elemLabel.className = "element-label";
      elemLabel.innerText = (type === "door" ? "Tür" : "Fenster") + " (" + defaults.width + " x " + defaults.height + " cm)";
      el.appendChild(elemLabel);
      el.dataset.realWidth = defaults.width;
      el.dataset.realHeight = defaults.height;
    }
    else if (type === "furniture") {
      el.dataset.elemText = defaults.elemText || ("Möbel " + elementCounter);
      const elemLabel = document.createElement("div");
      elemLabel.className = "element-label";
      elemLabel.innerText = el.dataset.elemText + " (" + defaults.width + " x " + defaults.height + " cm)";
      el.appendChild(elemLabel);
      el.dataset.realWidth = defaults.width;
      el.dataset.realHeight = defaults.height;
    }
    else if (type === "northarrow") {
      if (!defaults.width) defaults.width = 80;
      if (!defaults.height) defaults.height = 80;
      const drawnWidth = cmToPx(defaults.width);
      const drawnHeight = cmToPx(defaults.height);
      el.style.width = drawnWidth + "px";
      el.style.height = drawnHeight + "px";
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", drawnWidth);
      svg.setAttribute("height", drawnHeight);
      svg.setAttribute("viewBox", "0 0 100 100");
      const polygon = document.createElementNS(svgNS, "polygon");
      polygon.setAttribute("points", "50,5 20,40 40,40 40,95 60,95 60,40 80,40");
      polygon.setAttribute("fill", "#000");
      svg.appendChild(polygon);
      el.appendChild(svg);
    }

    if (type !== "door" && type !== "window" && type !== "northarrow") {
      const dimLabel = document.createElement("div");
      dimLabel.className = "dim-label";
      dimLabel.innerText = defaults.width + " x " + defaults.height + " cm";
      el.appendChild(dimLabel);
    }

    const resizeHandle = document.createElement("div");
    resizeHandle.className = "resize-handle";
    el.appendChild(resizeHandle);
    const rotateHandle = document.createElement("div");
    rotateHandle.className = "rotate-handle";
    el.appendChild(rotateHandle);

    el.addEventListener("pointerdown", function(e) {
      if(e.target.classList.contains("resize-handle") || e.target.classList.contains("rotate-handle")) return;
      selectElement(el);
    });

    makeDraggable(el);
    makeResizable(el, resizeHandle);
    makeRotatable(el, rotateHandle);

    document.getElementById("floorplan").appendChild(el);
    if (type === "room") updateRoomLabel(el);
  }

  function addNorthArrow() {
    createElement("northarrow", { left: 10, top: 10, width: 80, height: 80 });
  }

  function updateDimensionLabel(el, label) {
    label.innerText = el.dataset.realWidth + " x " + el.dataset.realHeight + " cm";
  }

  function makeDraggable(el) {
    el.addEventListener('pointerdown', function(e) {
      if (e.target.classList.contains('resize-handle') || e.target.classList.contains('rotate-handle')) return;
      e.preventDefault();
      let startX = e.clientX;
      let startY = e.clientY;
      let origX = el.offsetLeft;
      let origY = el.offsetTop;
      function pointerMoveHandler(e) {
        let dx = e.clientX - startX;
        let dy = e.clientY - startY;
        el.style.left = (origX + dx) + 'px';
        el.style.top = (origY + dy) + 'px';
        if (el === selectedElement) updatePropertiesPanel();
      }
      function pointerUpHandler() {
        document.removeEventListener('pointermove', pointerMoveHandler);
        document.removeEventListener('pointerup', pointerUpHandler);
      }
      document.addEventListener('pointermove', pointerMoveHandler);
      document.addEventListener('pointerup', pointerUpHandler);
    });
  }

  function makeResizable(el, handle) {
    handle.addEventListener('pointerdown', function(e) {
      e.stopPropagation();
      e.preventDefault();
      let startX = e.clientX;
      let startY = e.clientY;
      let startWidth = parseFloat(window.getComputedStyle(el).width);
      let startHeight = parseFloat(window.getComputedStyle(el).height);
      let dimLabel = el.querySelector(".dim-label");
      function pointerMoveHandler(e) {
        let newWidth = startWidth + (e.clientX - startX);
        let newHeight = startHeight + (e.clientY - startY);
        if(el.classList.contains("door") || el.classList.contains("window")){
          newHeight = cmToPx(20);
        }
        el.style.width = newWidth + 'px';
        el.style.height = newHeight + 'px';
        if(dimLabel) updateDimensionLabel(el, dimLabel);
        if(el.classList.contains("room")) updateRoomLabel(el);
        if (el === selectedElement) updatePropertiesPanel();
        if(el.classList.contains("door") || el.classList.contains("window")){
          let label = el.querySelector(".element-label");
          if(label){
            label.innerText = (el.classList.contains("door") ? "Tür" : "Fenster")
                              + " (" + el.dataset.realWidth + " x " + el.dataset.realHeight + " cm)";
          }
        }
        if(el.classList.contains("furniture")){
          let label = el.querySelector(".element-label");
          if(label){
            label.innerText = el.dataset.elemText + " (" + el.dataset.realWidth + " x " + el.dataset.realHeight + " cm)";
          }
        }
      }
      function pointerUpHandler() {
        document.removeEventListener('pointermove', pointerMoveHandler);
        document.removeEventListener('pointerup', pointerUpHandler);
      }
      document.addEventListener('pointermove', pointerMoveHandler);
      document.addEventListener('pointerup', pointerUpHandler);
    });
  }

  function makeRotatable(el, handle) {
    handle.addEventListener('pointerdown', function(e) {
      e.stopPropagation();
      e.preventDefault();
      let rect = el.getBoundingClientRect();
      let centerX = rect.left + rect.width / 2;
      let centerY = rect.top + rect.height / 2;
      let startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
      let initialRotation = el._currentRotation || 0;
      function pointerMoveHandler(e) {
        let currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
        let angleDiff = currentAngle - startAngle;
        let newRotation = initialRotation + angleDiff * (180/Math.PI);
        el.style.transform = 'rotate(' + newRotation + 'deg)';
        el._currentRotation = newRotation;
        if (el === selectedElement) updatePropertiesPanel();
      }
      function pointerUpHandler() {
        document.removeEventListener('pointermove', pointerMoveHandler);
        document.removeEventListener('pointerup', pointerUpHandler);
      }
      document.addEventListener('pointermove', pointerMoveHandler);
      document.addEventListener('pointerup', pointerUpHandler);
    });
  }

  function selectElement(el) {
    if(selectedElement) {
      selectedElement.classList.remove("selected");
    }
    selectedElement = el;
    selectedElement.classList.add("selected");
    updatePropertiesPanel();
  }

  function updatePropertiesPanel() {
    if(!selectedElement) return;
    document.getElementById("propWidth").value = Math.round((parseFloat(selectedElement.style.width) * scaleFactor) / pxPerCm);
    document.getElementById("propHeight").value = Math.round((parseFloat(selectedElement.style.height) * scaleFactor) / pxPerCm);
    document.getElementById("propRotation").value = Math.round(selectedElement._currentRotation || 0);

    if(selectedElement.classList.contains("room")){
      document.getElementById("roomExtra").style.display = "block";
      document.getElementById("propWallTop").value = selectedElement.dataset.wallTop;
      document.getElementById("propWallRight").value = selectedElement.dataset.wallRight;
      document.getElementById("propWallBottom").value = selectedElement.dataset.wallBottom;
      document.getElementById("propWallLeft").value = selectedElement.dataset.wallLeft;
      document.getElementById("propWallTypeTop").value = selectedElement.dataset.wallTypeTop;
      document.getElementById("propWallTypeRight").value = selectedElement.dataset.wallTypeRight;
      document.getElementById("propWallTypeBottom").value = selectedElement.dataset.wallTypeBottom;
      document.getElementById("propWallTypeLeft").value = selectedElement.dataset.wallTypeLeft;
      document.getElementById("propRoomLabel").value = selectedElement.dataset.roomLabel;
      document.getElementById("elemExtra").style.display = "none";
    } else {
      document.getElementById("roomExtra").style.display = "none";
      if(selectedElement.classList.contains("door") || selectedElement.classList.contains("window") || selectedElement.classList.contains("furniture")){
        document.getElementById("elemExtra").style.display = "block";
        let label = selectedElement.querySelector(".element-label");
        document.getElementById("propText").value = label ? label.innerText.split(" (")[0] : "";
      } else {
        document.getElementById("elemExtra").style.display = "none";
      }
    }
  }

  function updateProperties() {
    if(!selectedElement) return;
    let newWidth = document.getElementById("propWidth").value;
    let newHeight = document.getElementById("propHeight").value;

    selectedElement.dataset.realWidth = newWidth;
    selectedElement.dataset.realHeight = newHeight;

    if(selectedElement.classList.contains("door") || selectedElement.classList.contains("window")){
      selectedElement.style.width = cmToPx(newWidth) + "px";
      // Fix: Höhe wird fix 20 cm gezeichnet, Label soll aber den eingegebenen Höhenwert anzeigen
      selectedElement.style.height = cmToPx(20) + "px";
      selectedElement.dataset.enteredHeight = newHeight;
    } else {
      selectedElement.style.width = cmToPx(newWidth) + "px";
      selectedElement.style.height = cmToPx(newHeight) + "px";
    }

    let rotation = document.getElementById("propRotation").value;
    selectedElement.style.transform = 'rotate(' + rotation + 'deg)';
    selectedElement._currentRotation = rotation;

    if(selectedElement.classList.contains("room")){
      selectedElement.dataset.wallTop = document.getElementById("propWallTop").value;
      selectedElement.dataset.wallRight = document.getElementById("propWallRight").value;
      selectedElement.dataset.wallBottom = document.getElementById("propWallBottom").value;
      selectedElement.dataset.wallLeft = document.getElementById("propWallLeft").value;
      selectedElement.dataset.wallTypeTop = document.getElementById("propWallTypeTop").value;
      selectedElement.dataset.wallTypeRight = document.getElementById("propWallTypeRight").value;
      selectedElement.dataset.wallTypeBottom = document.getElementById("propWallTypeBottom").value;
      selectedElement.dataset.wallTypeLeft = document.getElementById("propWallTypeLeft").value;
      selectedElement.dataset.roomLabel = document.getElementById("propRoomLabel").value;
      updateRoomLabel(selectedElement);
      updateRoomWalls(selectedElement);
    }
    else if(selectedElement.classList.contains("door") || selectedElement.classList.contains("window") || selectedElement.classList.contains("furniture")){
      let newText = document.getElementById("propText").value;
      let label = selectedElement.querySelector(".element-label");
      if(label){
        label.innerText = (selectedElement.classList.contains("door") ? "Tür" : (selectedElement.classList.contains("window") ? "Fenster" : selectedElement.dataset.elemText))
                              + " (" + newWidth + " x " + newHeight + " cm)";
      }
    }
  }

  function deleteSelectedElement() {
    if(selectedElement) {
      selectedElement.remove();
      selectedElement = null;
      document.getElementById("propWidth").value = "";
      document.getElementById("propHeight").value = "";
      document.getElementById("propRotation").value = "";
      document.getElementById("propWallTop").value = "";
      document.getElementById("propWallRight").value = "";
      document.getElementById("propWallBottom").value = "";
      document.getElementById("propWallLeft").value = "";
      document.getElementById("propRoomLabel").value = "";
      document.getElementById("propText").value = "";
    }
  }

  function addRoom() {
    createElement("room", {
      left: 50,
      top: 50,
      width: 400,  // 400 cm real
      height: 300, // 300 cm real
      wallTop: 10,
      wallRight: 10,
      wallBottom: 10,
      wallLeft: 10,
      wallTypeTop: "außen",
      wallTypeRight: "außen",
      wallTypeBottom: "außen",
      wallTypeLeft: "außen",
      roomLabel: "Raum " + elementCounter
    });
  }
  function addDoor() {
    createElement("door", {
      left: 100,
      top: 100,
      width: 80,
      height: 210
    });
  }
  function addWindow() {
    createElement("window", {
      left: 150,
      top: 150,
      width: 120,
      height: 100
    });
  }
  function addFurniture() {
    createElement("furniture", {
      left: 200,
      top: 200,
      width: 100,
      height: 60,
      elemText: "Möbel: Sofa"
    });
  }
  function addNorthArrow() {
    createElement("northarrow", { left: 10, top: 10, width: 80, height: 80 });
  }

  // Direkte PDF-Ausgabe mittels html2pdf
  function printLayout() {
    const element = document.getElementById("printArea");
    const opt = {
      margin: 0,
      filename: 'Grundrissplan.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollX: 0, scrollY: 0 },
      jsPDF: { unit: 'px', format: [1587, 1085], orientation: 'landscape' }
    };
    html2pdf().set(opt).from(element).save().catch(function(err) {
       console.error("PDF-Erstellungsfehler: ", err);
       alert("PDF-Erstellung ist fehlgeschlagen. Bitte prüfe die Konsole.");
    });
  }

  function makeDraggable(el) {
    el.addEventListener('pointerdown', function(e) {
      if (e.target.classList.contains('resize-handle') || e.target.classList.contains('rotate-handle')) return;
      e.preventDefault();
      let startX = e.clientX;
      let startY = e.clientY;
      let origX = el.offsetLeft;
      let origY = el.offsetTop;
      function pointerMoveHandler(e) {
        let dx = e.clientX - startX;
        let dy = e.clientY - startY;
        el.style.left = (origX + dx) + 'px';
        el.style.top = (origY + dy) + 'px';
        if (el === selectedElement) updatePropertiesPanel();
      }
      function pointerUpHandler() {
        document.removeEventListener('pointermove', pointerMoveHandler);
        document.removeEventListener('pointerup', pointerUpHandler);
      }
      document.addEventListener('pointermove', pointerMoveHandler);
      document.addEventListener('pointerup', pointerUpHandler);
    });
  }

  function makeResizable(el, handle) {
    handle.addEventListener('pointerdown', function(e) {
      e.stopPropagation();
      e.preventDefault();
      let startX = e.clientX;
      let startY = e.clientY;
      let startWidth = parseFloat(window.getComputedStyle(el).width);
      let startHeight = parseFloat(window.getComputedStyle(el).height);
      let dimLabel = el.querySelector(".dim-label");
      function pointerMoveHandler(e) {
        let newWidth = startWidth + (e.clientX - startX);
        let newHeight = startHeight + (e.clientY - startY);
        if(el.classList.contains("door") || el.classList.contains("window")){
          newHeight = cmToPx(20);
        }
        el.style.width = newWidth + 'px';
        el.style.height = newHeight + 'px';
        if(dimLabel) updateDimensionLabel(el, dimLabel);
        if(el.classList.contains("room")) updateRoomLabel(el);
        if (el === selectedElement) updatePropertiesPanel();
        if(el.classList.contains("door") || el.classList.contains("window")){
          let label = el.querySelector(".element-label");
          if(label){
            label.innerText = (el.classList.contains("door") ? "Tür" : "Fenster")
                              + " (" + el.dataset.realWidth + " x " + el.dataset.realHeight + " cm)";
          }
        }
        if(el.classList.contains("furniture")){
          let label = el.querySelector(".element-label");
          if(label){
            label.innerText = el.dataset.elemText + " (" + el.dataset.realWidth + " x " + el.dataset.realHeight + " cm)";
          }
        }
      }
      function pointerUpHandler() {
        document.removeEventListener('pointermove', pointerMoveHandler);
        document.removeEventListener('pointerup', pointerUpHandler);
      }
      document.addEventListener('pointermove', pointerMoveHandler);
      document.addEventListener('pointerup', pointerUpHandler);
    });
  }

  function makeRotatable(el, handle) {
    handle.addEventListener('pointerdown', function(e) {
      e.stopPropagation();
      e.preventDefault();
      let rect = el.getBoundingClientRect();
      let centerX = rect.left + rect.width / 2;
      let centerY = rect.top + rect.height / 2;
      let startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
      let initialRotation = el._currentRotation || 0;
      function pointerMoveHandler(e) {
        let currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
        let angleDiff = currentAngle - startAngle;
        let newRotation = initialRotation + angleDiff * (180/Math.PI);
        el.style.transform = 'rotate(' + newRotation + 'deg)';
        el._currentRotation = newRotation;
        if (el === selectedElement) updatePropertiesPanel();
      }
      function pointerUpHandler() {
        document.removeEventListener('pointermove', pointerMoveHandler);
        document.removeEventListener('pointerup', pointerUpHandler);
      }
      document.addEventListener('pointermove', pointerMoveHandler);
      document.addEventListener('pointerup', pointerUpHandler);
    });
  }

  function selectElement(el) {
    if(selectedElement) {
      selectedElement.classList.remove("selected");
    }
    selectedElement = el;
    selectedElement.classList.add("selected");
    updatePropertiesPanel();
  }

  function updateDimensionLabel(el, label) {
    label.innerText = el.dataset.realWidth + " x " + el.dataset.realHeight + " cm";
  }

  // Direkte PDF-Ausgabe mittels html2pdf
  function printLayout() {
    const element = document.getElementById("printArea");
    const opt = {
      margin: 0,
      filename: 'Grundrissplan.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollX: 0, scrollY: 0 },
      jsPDF: { unit: 'px', format: [1587, 1085], orientation: 'landscape' }
    };
    html2pdf().set(opt).from(element).save().catch(function(err) {
       console.error("PDF-Erstellungsfehler: ", err);
       alert("PDF-Erstellung ist fehlgeschlagen. Bitte prüfe die Konsole.");
    });
  }

  function addNorthArrow() {
    createElement("northarrow", { left: 10, top: 10, width: 80, height: 80 });
  }
</script>

</body>
</html>
